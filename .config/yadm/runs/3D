#!/usr/bin/env bash

set -euo pipefail

# Source common utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/utils.sh"

# F3D and freecad
log_info "Setting up 3D tools..."
install_packages f3d freecad

# Function to install Blender
BLENDER_VERSION="5.0.1"
BLENDER_RELEASE_TAG="candidate+v50.0616cc718a03"
BLENDER_URL="https://cdn.builder.blender.org/download/daily/blender-$BLENDER_VERSION-$BLENDER_RELEASE_TAG-linux.x86_64-release.tar.xz"
BLENDER_ARCHIVE_FORMAT="tar.xz"
BLENDER_INSTALL_DIR="$HOME/.local/blender-$BLENDER_VERSION-$BLENDER_RELEASE_TAG-linux.x86_64-release"

# Find and suggest removal of old versions
find_old_versions "$HOME/.local/" "blender-*" "blender-$BLENDER_VERSION*"

# Install Blender
DESKTOP_CONTENT="[Desktop Entry]
Version=$BLENDER_VERSION
Name=Blender
Comment=Free and open-source 3D creation suite
GenericName=Blender
Exec=$BLENDER_INSTALL_DIR/blender
Icon=$HOME/.local/bin/icons/blender.svg
Terminal=false
Type=Application
Categories=Graphics;Science
StartupNotify=true"

install_archive "blender" "$BLENDER_URL" "$BLENDER_VERSION" "$BLENDER_INSTALL_DIR" "$BLENDER_ARCHIVE_FORMAT" &&
    create_desktop_entry "blender" "$DESKTOP_CONTENT"

log_info "3D setup completed successfully!"
